var loadingSchedule=loadingSchedule||{};loadingSchedule.Chart=function(t){function e(t,e,n,d,i,r){t.each(function(){for(var t,s=d3.select(this),l=e.split(/\s+/).reverse(),o=[],c=0,f=s.attr("x"),p=s.attr("y");c<d;){for(var u=s.append("tspan").attr("x",f).attr("y",p).attr("dy",1*c+i+"em").style("fill",r),g=l.length>0;g;)u.node().getComputedTextLength()<n?(t=l.pop())?(o.push(t),u.text(o.join(" ")),g=!0):g=!1:(o.length>1?(t=o.pop(),t=l.push(t),u.text(o.join(o.length>1?" ":""))):(u.text(o.join("")),a(u,n,12)),g=!1);c++,o=[]}})}function a(t,e,a){for(var n=t.text().split("");t.node().getComputedTextLength()>2*a+e;)n.pop(),t.text(n.join("")+"...")}this.getVersion=function(){return"0.4.0"},Date.prototype.addDays=function(t){var e=new Date(this.valueOf());return e.setDate(e.getDate()+t),e},Date.prototype.equals=function(t){return new Date(this.valueOf()).getTime()===t.getTime()};var n=this,d=0,i=0;this.setChartWidth=function(t){d=t},n.getChartWidth=function(){return d},n.setChartHeight=function(t){i=t},n.getChartHeight=function(){return i},n.xOffset=120,n.yOffset=50,n.padding=4,n.barHeight=7,n.eventFontSize=11,n.lineK=1.5,this.refreshChart=function(t,a,d,i,r){var s=t.getAttribute("id");if(null!=s){var l,o,c,f=d3.timeParse("%d.%m.%Y"),p=(l=a,c=(c=12*((o=d).getFullYear()-l.getFullYear()))-l.getMonth()+1,(c+=o.getMonth())<=0?0:c),u=450*(p>4?p:4)+n.xOffset+10,g=0;i.forEach(function(t){var e=r.filter(function(e){return e.room.id===t.id}),a=e.length>0?d3.max(e,function(t){return t.line}):0;g=a>0?a:g+1});var x=80*g+n.yOffset+10,h=d3.select("div#"+s);h.select("svg").remove();var y=h.append("svg").attr("id","schedule-chart").attr("viewBox","0 0 "+u+" "+x).attr("width",u).attr("height",x).attr("version","1.1"),v=u-n.xOffset-10,m=x-n.yOffset-10;r.forEach(function(t){t.d1=f(t.d1),t.d2=f(t.d2),t.d3=f(t.d3),t.d4=f(t.d4),t.optionDate=f(t.optionDate)});var O=d3.scaleLinear().domain([0,g*n.lineK]).range([0,m]),b=d3.scaleTime().domain([a,d]).range([0,v]),D=d3.axisLeft(O).ticks(4*g).tickSize(0).tickPadding(6).tickFormat(function(){return null}),k=d3.axisTop(b).ticks(d3.timeMonth.every(1)).tickFormat("").tickSize(0).tickPadding(6),S=d3.axisTop(b).ticks(d3.timeDay.every(1)).tickSize(0).tickPadding(34).tickFormat(function(t){return 15===t.getDate()?["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"][t.getMonth()]+" "+t.getFullYear():null}),z=d3.axisTop(b).ticks(d3.timeDay.every(1)).tickFormat(function(t){return t.getDate()%2?d3.timeFormat("%_d")(t):null}).tickSize(8).tickPadding(6),F=y.append("g").attr("id","coordinates");F.append("g").classed("axis",!0).classed("y-axis",!0).attr("transform","translate("+n.xOffset+", "+n.yOffset+")").call(D),F.append("g").classed("axis",!0).classed("x-axis",!0).classed("days",!0).classed("labeled",!0).style("position","fixed").attr("transform","translate("+n.xOffset+", "+n.yOffset+")").call(z),F.append("g").classed("axis",!0).classed("months",!0).attr("transform","translate("+n.xOffset+", "+n.yOffset+")").call(k),F.append("g").classed("axis",!0).classed("months",!0).classed("labeled",!0).attr("transform","translate("+n.xOffset+", "+n.yOffset+")").call(S),d3.selectAll("g.y-axis g.tick:first-of-type").append("line").classed("grid-line",!0).attr("x1",-n.xOffset).attr("y1",0).attr("x2",0).attr("y2",0),d3.selectAll("g.months g.tick").append("line").classed("grid-line",!0).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",m);var C=y.append("g").attr("id","values"),H=0,j=0,q=String.fromCharCode(8647),w=String.fromCharCode(8649);i.forEach(function(t){var i=C.append("g").attr("id",t.id).classed("object-info",!0),s=d3.nest().key(function(t){return t.line}).sortKeys(d3.ascending).entries(r.filter(function(e){return e.room.id===t.id}));j=(s.length>0?s.length:1)*n.lineK+j,i.append("text").classed("objects",!0).classed("labeled",!0).attr("x",b(a)+n.padding).attr("y",function(){return O((j+H)/2)+n.yOffset}).call(e,t.name_ru,n.xOffset-n.padding,3,0);var l=i.append("g").classed("object-events",!0);s.forEach(function(t){t.values.forEach(function(t){if(t.d1<d&&t.d4>a){var i,r,s=l.append("g").attr("id",t.uuid).classed("event-info",!0),o=s.append("g").classed("event-dates",!0),c=O(n.lineK*(t.line-.75))+n.yOffset,f=t.d1<a?a:t.d1,p=t.d4>d?d:t.d4.addDays(1),u=b(f)+n.xOffset;t.d2>=a&&o.append("text").classed("event-inst-date",!0).attr("x",u).attr("y",c-n.padding).attr("text-anchor","middle").attr("font-size",n.eventFontSize).text(function(){return t.d1<a?q:t.d1.equals(t.d2)?"":t.d1.getDate()}),t.d3>=a&&t.d1<d&&(i=t.d2<a?a:t.d2,o.append("text").classed("text.event-start-date",!0).attr("x",function(){var e=b(t.d2>d?d:i);return t.d2.equals(t.d3)?e=(b(t.d2)+b(t.d2.addDays(1)))/2:t.d1>a&&t.d1.addDays(1).equals(t.d2)&&(e+=n.padding),e+n.xOffset}).attr("y",c-n.padding).attr("text-anchor","middle").attr("font-size",n.eventFontSize).text(function(){return t.d2<a?q:t.d2>d?w:i.getDate()})),t.d4>=a&&t.d2<=d&&(r=t.d3>=d?d:t.d3.addDays(1),o.append("text").classed("event-end-date",!0).attr("x",function(){var e=b(t.d3<a?a:r);return t.d3<d&&!t.d2.equals(t.d3)&&t.d3.addDays(1).equals(t.d4)&&(e-=n.padding),e+n.xOffset}).attr("y",c-n.padding).attr("text-anchor","middle").attr("font-size",n.eventFontSize).text(function(){return t.d3<a?q:t.d3>d?w:t.d2.equals(t.d3)?"":t.d3.getDate()})),t.d4>a&&t.d3<=d&&o.append("text").classed("event-deinst-date",!0).attr("x",b(p)+n.xOffset).attr("y",c-n.padding).attr("text-anchor","middle").attr("font-size",n.eventFontSize).text(function(){return t.d4>d?w:t.d3.equals(t.d4)?"":t.d4.getDate()});var g=s.append("g").classed("event-bars",!0);t.d2>a&&t.d1<d&&(i=t.d2>=d?d:t.d2,g.append("rect").classed("bar",!0).classed("inst-bar",!0).attr("x",b(f)+n.xOffset).attr("y",c).attr("width",b(i)-b(f)).attr("height",n.barHeight).attr("fill",t.addColor)),t.d1>=a&&g.append("line").classed("black-line",!0).classed("inst-line",!0).attr("x1",u).attr("y1",c).attr("x2",u).attr("y2",c+n.barHeight),t.d3>=a&&t.d2<d&&(i=t.d2<a?a:t.d2,g.append("rect").classed("bar",!0).classed("event-bar",!0).attr("x",b(i)+n.xOffset).attr("y",c).attr("width",b(r)-b(i)+1).attr("height",n.barHeight).attr("fill",t.mainColor)),t.d4>a&&t.d3<d&&(r=t.d3<a?a:t.d3.addDays(1),g.append("rect").classed("bar",!0).classed("deinst-bar",!0).attr("x",b(r)+n.xOffset).attr("y",c).attr("width",b(p)-b(r)).attr("height",n.barHeight).attr("fill",t.addColor)),t.d4<=d&&g.append("line").classed("black-line",!0).classed("deinst-line",!0).attr("x1",b(p)+n.xOffset).attr("y1",c).attr("x2",b(p)+n.xOffset).attr("y2",c+n.barHeight),s.append("g").classed("event-title",!0).append("text").classed("event-name",!0).attr("x",(b(f)+b(p))/2+n.xOffset).attr("y",c+n.eventFontSize+n.barHeight).attr("text-anchor","middle").attr("font-size",n.eventFontSize).call(e,t.project.name_ru,b(p)-b(f),2,0).call(e,null!=t.optionDate?"Опцион "+function(t,e){e=void 0!==e&&e;var a=t.getDate(),n=t.getMonth()+1,d=t.getFullYear().toString();return(a<=9?"0"+a:a)+"."+(n<=9?"0"+n:n)+"."+d.substring(d.length-(e?2:d.length))}(t.optionDate,!0):"",b(p)-b(f)+3,2,2,"red")}})}),i.append("g").classed("axis",!0).classed("y-axis",!0).append("line").classed("grid-line",!0).attr("opacity",1).attr("x1",0).attr("y1",O(j)+n.yOffset).attr("x2",v+n.xOffset).attr("y2",O(j)+n.yOffset),H=j}),C.append("g").attr("id","collisions").selectAll("ellipse.event-collision").data(r).enter().filter(function(t){return t.d1<d&&t.d4>a&&t.collision}).append("ellipse").classed("event-collision",!0).attr("cx",function(t){t.collision.d1=f(t.collision.d1),t.collision.d4=f(t.collision.d4);var e=t.d1>=t.collision.d1?t.d1:t.collision.d1,a=t.d4>=t.collision.d4?t.collision.d4:t.d4;return(b(e)+b(a))/2+n.xOffset}).attr("cy",function(t){var e=t.line>t.collision.line?t.collision.line:t.line,a=K(t.line,t.collision.line);return O(n.lineK*(e-.75))+a+4+n.yOffset}).attr("rx",function(){return 10}).attr("ry",function(t){return K(t.line,t.collision.line)+6}).attr("fill","none").style("stroke","firebrick").style("stroke-width","1px")}function K(t,e){var a=n.lineK*(t-.75),d=n.lineK*(e-.75);return O(Math.abs(a-d))/2}}};